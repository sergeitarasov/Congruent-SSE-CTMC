---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
plot(cars)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.


### COR8-NC, BETTER

```{r}

s1 <- 0.075
s2 <- 0.075

sam.fr8 = list(
  c(1-s1, 1-s2, 1-s1, 1-s2,  1-s1, 1-s2, 1-s1, 1-s2,   s1, 0, s1, 0,  s1, 0, s1, 0),
  c(1-s1, 1-s2, 1-s1, 1-s2,  1-s1, 1-s2, 1-s1, 1-s2,   0, s2, 0, s2,  0, s2, 0, s2)
)

Args <- list(
  Nstates = 8L,
  y = sam.fr8
    )

newArgs <- makeArgs(Args)
#printArgsGlobal()
args <- argnames_HiClaSSE(8)

pars.hc <- rep(0, length(args$pars))
names(pars.hc) <- args$pars
pars.hc['lam000'] <- 0.1
pars.hc['lam111'] <- 0.1
pars.hc['lam222'] <- 0.1
pars.hc['lam333'] <- 0.1
pars.hc['lam444'] <- 0.05
pars.hc['lam555'] <- 0.05
pars.hc['lam666'] <- 0.05
pars.hc['lam777'] <- 0.05
pars.hc['mu0'] <-pars.hc['mu1'] <- pars.hc['mu2'] <- pars.hc['mu3'] <- pars.hc['mu4']<- pars.hc['mu5']<- pars.hc['mu6']<- pars.hc['mu7'] <-0.1





```

#### Run inference

```{r}
# v=c(1,3, 2,4)
# Q.focal[v,v]
# Q_cid8.t
# Q_cid8.r
# #Q_cor8_NC.r


set2 <- ger_partitionsNK(N=8, K_expression='==2')
v2=c(1,5,2,6, 3,7,4,8)
  
COR8_NC.multi <- list()
i=1
for (i in 1:ncol(set2)){
  #---
  cat= set2[,i]
  cat=ifelse(cat==2, 0, 1)
  Qnew <- Q_cid8.t*10
  
  Qnew[1,3] <- cat[1]
  Qnew[1,4] <- cat[2]
  Qnew[2,3] <- cat[3]
  Qnew[2,4] <- cat[4]
  
  Qnew[5,1] <- cat[5]
  Qnew[5,2] <- cat[6]
  Qnew[6,1] <- cat[7]
  Qnew[6,2] <- cat[8]
  
  # Qnew[1,3] <- 2
  # Qnew[1,4] <- 2
  # Qnew[2,3] <- 2
  # Qnew[2,4] <- 2
  # Qnew[5,1] <- 2
  # Qnew[5,2] <- 2
  # Qnew[6,1] <- 2
  # Qnew[6,2] <- 2
  #Qnew
  Qnew <- Qnew[v2,v2]
  
  qs <- extract_off_diagonal(Qnew)
  qsl=length(qs)
  pars.hc[c(length(pars.hc)-qsl+1):length(pars.hc)] <- qs

  zero.constr <- formulas_zero_pars(pars.hc)
  f.qs <- assign_classes_pairwise(Qnew, args$arrays$Q)
  f.mu <- c(mu1 ~ mu0, mu2 ~ mu0, mu3 ~ mu0,  mu5 ~ mu4, mu6 ~ mu4, mu7 ~ mu4)
  f.lams <- c(lam111 ~ lam000, lam222 ~ lam000, lam333 ~ lam000,   
            lam555 ~ lam444, lam666 ~ lam444, lam777 ~ lam444)
  f.list<- c(zero.constr,  f.qs, f.mu, f.lams)
  
  
  lik.c <- make.HiClasse_cpp(tree, states,  sampling.f=NULL,  strict=TRUE, control=list(backend = "gslode"), newArgs)
  lik.const <- constrain(lik.c, formulae = f.list)
  arg.const <- argnames(lik.const)
  starting.point <- pars.hc[arg.const]
  
  starting.point[['lam000']] <-0.288701
  starting.point[['lam444']] <-0.1292103
  starting.point[['mu0']] <-0.2639205
  starting.point[['mu4']] <-0.01172136
  starting.point[5] <- 0.001190693
  #starting.point[6] <- 0.001190693
  
  COR8_NC.multi[[i]] <- find.mle(lik.const, starting.point, intermediates=F,  method="subplex", keep.func=F, root=ROOT.OBS, condition.surv=TRUE)
  print(i)
  print(get_aic(COR8_NC.multi[[i]]$lnLik, 5))
  saveRDS(COR8_NC.multi, 'COR8_NC.multi-zero.rds')
  #saveRDS(COR8_NC.multi, 'COR8_NC.multi')
  #print(COR8_NC.multi[[i]]$lnLik)
  # -988.3828
}



# COR8_NC_n <- find.mle(lik.const, starting.point, method="subplex", keep.func=F, root=ROOT.OBS, condition.surv=TRUE)
# COR8_NC_n$lnLik
# # -988.3408
# get_aic(COR8_NC_n$lnLik, 5) 
# get_aic(CID4$lnLik, 5)

# -987.7285
#-987.7178
# 1982.767
```



```{r}
aic=get_item(COR8_NC.multi, 'lnLik') %>% get_aic(., 5)
aic
min(aic)
#which(ln==max(ln))
```
